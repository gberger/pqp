<h1>Listing Study Materials</h1>

<%= bootstrap_form_for StudyMaterial.new do |f| %>
  <p>
    Todo arquivo deve estar precedido do código de sua <%= link_to 'disciplina', courses_path %> (<%= link_to 'que já exista', new_course_path %>) e um traço.
    Exemplo: "MAT1200-Lista 1.pdf".
  </p>
  <p>
    Arquivos de provas devem obedecer o formato <code>CODIGO-ANO-PERIODO-PX-INFO</code>.
    Por exemplo: "INF1007-2008-1-P4-enunciado.pdf".
    <code>INFO</code> pode qualquer coisa, mas nomes comuns são "Enunciado", "Gabarito", "Turma A-Enunciado", "Tudo".
  </p>
  <p>
    Arquivos que não são de provas (listas, resumos, etc) podem ser enviados com qualquer nome, desde que obedeçam a regra da disciplina.
    Para fazer uso de um arquivo desse no plano de estudo, use o código fornecido na coluna <strong>Markdown</strong>.
  </p>
  <p>
    É possível selecionar vários arquivos de uma vez, ou até mesmo arrastar e soltar (drag and drop).
  </p>

  <%= f.file_field :content, multiple: true, name: 'study_material[content]' %>
<% end %>

<br>

<table class="table" id="study_materials_table">
  <thead>
    <tr>
      <th>Disciplina</th>
      <th>Prova</th>
      <th>Título</th>
      <th>URL</th>
      <th>Markdown</th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    <% @study_materials.each do |study_material| %>
      <%= render partial: 'table_row', locals: {study_material: study_material} %>
    <% end %>
  </tbody>
</table>

<script id="template-upload" type="text/x-tmpl">
  <div class="upload panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">{%=o.name%}</h3>
    </div>
    <div class="panel-body">
      <div class="progress progress-striped active">
        <div class="progress-bar active" role="progressbar" style="width: 0%"></div>
      </div>
    </div>
  </div>
</script>

<script>
  $(function(){
    $('#new_study_material').fileupload({
      dataType: "script",
      add: function(e, data){

        if(!/^[A-Z]{3}\d{4}\-/.test(data.files[0].name)){
          alert("Nome do arquivo precisa começar com o código da disciplina e um traço. Exemplo: \"MAT1200-Lista 1.pdf\"");
          return false;
        }

        data.context = $(tmpl("template-upload", data.files[0]));
        $('#new_study_material').append(data.context);
        data.submit()
      },
      progress: function(e, data){
        if(data.context){
          progress = parseInt(data.loaded/data.total * 100, 10);
          data.context.find('.progress-bar').css('width', progress + '%');
        }
      },
      done: function(e, data){
        if(data.context){
          data.context.find('.progress').removeClass('progress-striped active');
          data.context.find('.progress-bar').addClass('progress-bar-success');
        }
      }
    });
  })
</script>